---
title: "ASP_model_simulation"
author: "Cher"
date: "9/26/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(gtools)
library(ggpubr)
library(rstatix)
library(ggpubr)
rm(list = ls())
```
### simulation data - per conditionn
```{r}
model1_mean <- c(0.97625, 0.97675, 0.40575, 0.4045)#c(0.5936, 0.6088, 0.4068, 0.404) 
model1_std <- c(0.04935521755599882, 0.04908602143176807, 0.1556179215257674, 0.15509593805125915)

model2_data <- c(0.664, 0.536, 0.34, 0.32)

pd<-position_dodge(0.1)
df_summary <- data.frame(
  P_type=c('DOC', 'DOI', 'POC', 'POI'),
  mean=c(0.98 , 0.971, 0.416, 0.443),
  std=c(0.0424, 0.0535, 0.1528, 0.1387)) %>%
  mutate( 
    syn_voice=as.factor(ifelse((P_type=="DOC")|(P_type=="DOI"), "DO", "PO")),
    syn_corr=as.factor(ifelse((P_type=="DOC")|(P_type=="POC"), "C", "I")),
    mean_upper=mean+std,
    mean_lower=mean-std,
    mean_upper=(ifelse(mean_upper>1, 1, mean_upper)))
param='N: 32000; ans: 0.3; bll: 0.8; lf: 0.5;'

model_plot <- df_summary %>%
  ggplot(aes(x=syn_voice, y=mean,  group=syn_corr, col=syn_corr)) + 
  geom_col(stat="identity", position='dodge2', 
           width = .7, colour="black") + 
  ylim(c(0,1))  + 
  ggtitle('Simulation Results of ACT-R Declarative Model (Model 1)', 
          subtitle = param) + 
  labs(x = "Prime Conditions", 
       y='Proportion of DO descriptions') +
  scale_fill_manual(values=c("white", "gray"), labels = c("Correct", "Incorrect"), name = "Syntactic Correctness") +
  theme_gray(base_size = 20)
model_plot+theme(legend.position = c(0.8,0.8))


  
```

### simulation data
```{r}
# read model simulation data
# skip second line (params)
sim_data <- "./MODEL220201027233740.txt"

df <- read.csv(sim_data, header = TRUE,  sep = ",")[-1,]
param <- as.character(read.csv(sim_data, header = FALSE,  sep = ",")[2,1])

# data summary
df_summary <- df %>%
  gather(key='P_type', value='prop_DO', DOC:POI) %>%
  mutate(P_type=as.factor(P_type), 
         prop_DO=as.numeric(prop_DO),
         syn_voice = as.factor(ifelse((P_type=="DOC")|(P_type=="DOI"), 
                            "DO", "PO")),
         syn_corr = as.factor(ifelse((P_type=="DOC")|(P_type=="POC"), 
                            "C", "I"))) %>%
  group_by(P_type, syn_voice, syn_corr) %>%
  get_summary_stats(type = 'mean_se')
```


plot
```{r}
# change name
#levels(df_summary$P_type) <- c("S1C","S1I","S2C","S2I")
#levels(df_summary$syn_voice) <- c("S1","S2")

model_plot <- df_summary %>%
  ggplot(aes(x=syn_voice, y=mean,  group=syn_corr, fill=syn_corr)) + 
  geom_col(stat="identity", position='dodge2', 
           width = .7, colour="black") + 
  #geom_text(aes(label = round(mean,2)), 
  #          position = position_dodge(0.7),  vjust = 5) +
  geom_errorbar(aes(ymin = mean-se, 
                    ymax = mean+se), 
                width=0.1, 
                position=position_dodge(width=0.7)) +
  #ylim(c(0,1))  + 
  ggtitle('Results of ACT-R Surprisal Model', 
          subtitle = param) + 
  labs(x = "Prime Conditions", 
       y='Proportion of DO descriptions') +
  scale_fill_manual(values=c("white", "gray"), labels = c("Correct", "Incorrect"), name = "Syntactic Correctness") +
  theme_gray(base_size = 20)

model_plot + theme(legend.position = c(0.8, 0.8))
```

```{r}
files <- list.files('./20201019', full.names = TRUE)

# add param columns
funct1 <- function(file_path) {
  df <- read.csv(file_path, header = TRUE,  sep = ",")[-1,]
  df_param_string <- as.character(read.csv(file_path, header = FALSE,  sep = ",")[2,1])
  df$param_ans <- str_split(str_split(df_param_string, "; ", simplify = TRUE)[,1], ": ", simplify = TRUE)[,2]
  df$param_bll <- str_split(str_split(df_param_string, "; ", simplify = TRUE)[,2], ": ", simplify = TRUE)[,2]
  df$param_lf <- str_split(str_split(df_param_string, "; ", simplify = TRUE)[,3], ": ", simplify = TRUE)[,2]
  return (df)
}


# concate all dfs
funct2 <- function(files){
  df = data.frame()
  for (f in files){
    df1 = funct1(f)
    df = rbind(df, df1)
  }
  return(df)
}

df <- funct2(files)
```

### Convert sim data to long format
```{r}
# convert to long format
long_df <- df %>%
  gather(key='P_type', value='prop_DO', DOC:POI) %>%
  mutate(P_type=as.factor(P_type), 
         prop_DO=as.numeric(prop_DO),
         syn_voice = as.factor(ifelse((P_type=="DOC")|(P_type=="DOI"), 
                            "DO", "PO")),
         syn_corr = as.factor(ifelse((P_type=="DOC")|(P_type=="POC"), 
                            "C", "I")),
         param_ans = as.factor(param_ans),
         param_bll = as.factor(param_bll),
         param_lf = as.factor(param_lf))

p3 <- long_df %>% 
  filter(param_ans==0.1, param_bll==0.2) %>%
  group_by(P_type, syn_voice, syn_corr, param_lf) %>%
  get_summary_stats(type = 'mean_se') %>%
  ggplot(aes(x=P_type, y=mean, col=param_lf, group=param_lf)) + geom_point() + geom_line()
  #+ facet_grid(cols = vars(param_ans))

p1
p2
p3
```

### Convert sim data to long format
```{r}
long_df <- df %>%
  gather(key='P_type', value='prop_DO', DOC:POI) %>%
  mutate(P_type=as.factor(P_type), 
         prop_DO=as.numeric(prop_DO),
         syn_voice = as.factor(ifelse((P_type=="DOC")|(P_type=="DOI"), 
                            "DO", "PO")),
         syn_corr = as.factor(ifelse((P_type=="DOC")|(P_type=="POC"), 
                            "C", "I")))
```

### Load Subj Data
```{r}
long_df %>%
  group_by(param_ans, param_bll, param_lf, P_type) %>%
  get_summary_stats(type = 'mean')

subj_data <- read.csv('../subj_data/ASP3_double_checked.csv')

subj_summary <- subj_data %>% 
  mutate(isdo=as.numeric(1-ispo),
         subjID=surveyID) %>%
  select(subjID, P_type, isdo) %>%
  group_by(subjID, P_type) %>%
  get_summary_stats(type = 'mean')

# transform subj data
wide_subj_summary <- subj_summary %>%
  select(subjID, P_type, mean) %>%
  spread(P_type, mean)

write_csv(wide_subj_summary, './ASP3SubjData20201209_clean.csv')
```

### Calcualte RSS
```{r}

subj_summary %>%
  ggplot(aes(x=P_type, y=mean, col=subjID)) + 
  geom_point() + geom_jitter()

# wide format of subj data
subj_wide <- subj_summary %>%
  select(-variable, -n) %>%
  spread(key = P_type, value = mean)

# model1
model1 <- long_df %>% 
  filter(param_ans==0.1, param_bll==0.2, param_lf==0.2) %>%
  group_by(P_type, syn_voice, syn_corr) %>%
  get_summary_stats(type = 'mean') %>%
  select(P_type, mean) %>%
  spread(key = P_type, value=mean) 

# model1
model2 <- long_df %>% 
  filter(param_ans==0.5, param_bll==0.5, param_lf==0.8) %>%
  group_by(P_type, syn_voice, syn_corr) %>%
  get_summary_stats(type = 'mean') %>%
  select(P_type, mean) %>%
  spread(key = P_type, value=mean) 

# calculate RSS given predicted y and observation
calc_RSS <- function(subj_wide, model1) {
  DOC_rss = sum((subj_wide$DOC-model1$DOC)^2)
  DOI_rss = sum((subj_wide$DOI-model1$DOI)^2)
  POC_rss = sum((subj_wide$POC-model1$POC)^2)
  POI_rss = sum((subj_wide$POI-model1$POI)^2)
  rss = DOC_rss+DOI_rss+POC_rss+POI_rss
  return(rss)
}

# calculate BIC
calc_BIC <- function(RSS, n, k) {
  bic = n + n*log(2*pi) + n*log(RSS/n) + log(n)*(k+1)
  return (bic)
}
rss1 <- calc_RSS(subj_wide, model1)
rss2 <- calc_RSS(subj_wide, model2)

bic1 <- calc_BIC(rss1, 47, 3)
bic1

bic2 <- calc_BIC(rss2, 47, 3)
bic2
```


### Optimization
```{r}
dfo <- read.csv('./model2_param_optimization.csv', header = TRUE,  sep = ",") %>% arrange(rmse)
  #mutate(ans=factor(ans), bll=factor(bll), ga=factor(ga), lf=factor(lf), mas=factor(mas))
dfo %>% head()
dfo %>%
  filter(ans==0.7, rmse<0.18) %>%
  #group_by(bll) %>%
  ggplot(aes(X, rmse, group=ans, col=ans)) + geom_point(alpha=0.5)
```


#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 20201209

### Hypothesis plot
```{r}
hypo1 = do.call("rbind", replicate(2, data.frame(mean_prop = c(.75, .75, .45, .45), syn_corr=c("C", "I", "C", "I"), syn_voice=c("Active", "Active", "Passive", "Passive"), P_type=c("AC", "AI", "PC", "PI")), simplify = FALSE))
hypo2 = do.call("rbind", replicate(2, data.frame(mean_prop = c(.75, .85, .45, .25), syn_corr=c("C", "I", "C", "I"), syn_voice=c("Active", "Active", "Passive", "Passive"), P_type=c("AC", "AI", "PC", "PI")), simplify = FALSE))
hypo3 = do.call("rbind", replicate(2, data.frame(mean_prop = c(.75, .65, .45, .55), syn_corr=c("C", "I", "C", "I"), syn_voice=c("Active", "Active", "Passive", "Passive"), P_type=c("AC", "AI", "PC", "PI")), simplify = FALSE))


h1.plot = hypo1 %>% ggbarplot(x = "syn_voice", y = "mean_prop", add = "mean",
                               color = "syn_corr", size = 2,
                               palette = "jco", position = position_dodge(0.8),
                               label = FALSE, label.pos = "in",  lab.nb.digits = 2, lab.vjust = 3)  +
  ggtitle("Hypothesis 1") + 
  labs(x = "Syntactic Structure", color='Syntactic Correctness', y ="Proportion of Active descriptions") + 
  ylim(c(0,1)) + 
  theme_classic(base_size = 25) + 
  theme(legend.position = "top", axis.text.y = element_blank())

h2.plot = hypo2 %>%
  ggbarplot(x = 'syn_voice', y = 'mean_prop', add = "mean", size = 2, 
            col = 'syn_corr', palette = 'jco', position = position_dodge(0.8)) + 
  ggtitle("Hypothesis 2") + 
  labs(x = "Syntactic Structure", y= "Proportion of Active descriptions", col = "Syntactic Correctness") + 
  ylim(c(0,1)) + 
  theme_classic(base_size = 25) + 
  theme(legend.position = "top", axis.text.y = element_blank())

h3.plot = hypo3 %>%
  ggbarplot(x = 'syn_voice', y = 'mean_prop', size = 2, 
            col = 'syn_corr', palette = 'jco', position = position_dodge(0.8)) + 
  ggtitle("Hypothesis 3") + 
  labs(x = "Syntactic Structure", y= "Proportion of Active descriptions", col = "Syntactic Correctness") + 
  ylim(c(0,1)) + 
  theme_classic(base_size = 25) + 
  theme(legend.position = "top", axis.text.y = element_blank())

h.plot = ggarrange(h1.plot, h2.plot, h3.plot, nrow=1, ncol=3)

h.plot

```

### model plots
```{r}
model1 = read_csv('./MODEL1/MODEL1_wide.csv') %>% 
  select(mid:POI) %>%
  rename(AC=DOC,AI=DOI,PC=POC, PI=POI)
model2 = read_csv('./MODEL2/MODEL2_wide.csv') %>% 
  select(mid:POI) %>%
  rename(AC=DOC,AI=DOI,PC=POC, PI=POI)
model3 = read_csv('./MODEL3/MODEL3_wide.csv') %>% 
  select(mid:POI) %>%
  rename(AC=DOC,AI=DOI,PC=POC, PI=POI)


rmse = function(m, o){
  return (sqrt(mean((m - o)^2)))
}

rmse_diff = function(m, o) {
  m0 = mean(m[1], m[2], trim = 0.0001) - mean(m[3], m[4])
  d1 = m[1] - m[2]
  d2 = m[3] - m[4]
  
}



model1.plot <- model1 %>%
  gather('P_type', 'mean_prop', AC:PI) %>%
  mutate(syn_voice = factor(ifelse(P_type=="AC"|P_type=="AI", "Active", "Passive")),
         syn_corr = factor(ifelse(P_type=="AC"|P_type=="PC", "Correct", "Incorrect"))) %>% 
  ggbarplot(x = 'syn_voice', y = 'mean_prop', size = 2, add = c("mean"), 
            col = 'syn_corr', palette = 'jco', position = position_dodge(0.8)) + 
  ggtitle("Simulation results of Model 1", subtitle = paste0("N = ", 50*40)) + 
  labs(x = "Syntactic Structure", y= "Proportion of Active descriptions", col = "Syntactic Correctness") + 
  ylim(c(0,1)) + 
  theme_classic(base_size = 25) + 
  theme(legend.position = "top")

model2.plot <- model2 %>%
  gather('P_type', 'mean_prop', AC:PI) %>%
  mutate(syn_voice = factor(ifelse(P_type=="AC"|P_type=="AI", "Active", "Passive")),
         syn_corr = factor(ifelse(P_type=="AC"|P_type=="PC", "Correct", "Incorrect"))) %>% 
  ggbarplot(x = 'syn_voice', y = 'mean_prop', size = 2, add = c("mean"), 
            col = 'syn_corr', palette = 'jco', position = position_dodge(0.8)) + 
  ggtitle("Simulation results of Model 2", subtitle = paste0("N = ", 50*40)) + 
  labs(x = "Syntactic Structure", y= "Proportion of Active descriptions", col = "Syntactic Correctness") + 
  ylim(c(0,1)) + 
  theme_classic(base_size = 25) + 
  theme(legend.position = "top")

model3.plot <- model3 %>%
  gather('P_type', 'mean_prop', AC:PI) %>%
  mutate(syn_voice = factor(ifelse(P_type=="AC"|P_type=="AI", "Active", "Passive")),
         syn_corr = factor(ifelse(P_type=="AC"|P_type=="PC", "Correct", "Incorrect"))) %>% 
  ggbarplot(x = 'syn_voice', y = 'mean_prop', size = 2, add = c("mean"), 
            col = 'syn_corr', palette = 'jco', position = position_dodge(0.8)) + 
  ggtitle("Simulation results of Model 3", subtitle = paste0("N = ", 50*40)) + 
  labs(x = "Syntactic Structure", y= "Proportion of Active descriptions", col = "Syntactic Correctness") + 
  ylim(c(0,1)) + 
  theme_classic(base_size = 25) + 
  theme(legend.position = "top")

models.plot <- ggarrange(model1.plot, model2.plot, model3.plot, nrow=1, ncol=3)

models.plot 

```


### Individual diff - no use
```{r}
fit1to1 <- read_csv("./MODEL1/ASP1MODEL1_reg.csv")
fit1to2 <- read_csv("./MODEL2/ASP1MODEL2_reg.csv")
fit1to3 <- read_csv("./MODEL3/ASP1MODEL3_reg.csv")
#hist(fit1to1$min_rmse)
#hist(fit1to2$min_rmse)
#hist(fit1to3$min_rmse)

fit3to1 <- read_csv("./MODEL1/ASP3MODEL1_reg.csv")
fit3to2 <- read_csv("./MODEL2/ASP3MODEL2_reg.csv")
fit3to3 <- read_csv("./MODEL3/ASP3MODEL3_reg.csv")
#hist(fit3to1$min_rmse)
#hist(fit3to2$min_rmse)
#hist(fit3to3$min_rmse)


s1m1 <- fit1to1 %>%
    select(mAC, mAI, mPC, mPI) %>%
    gather(key = "P_type", value = mean_prop, mAC:mPI) %>%
    group_by(P_type) %>%
    get_summary_stats(type = 'mean_se') %>%
    select(P_type, mean, se) %>%
    mutate(data_type = 'Model1')
s1m2 <- fit1to2 %>%
    select(mAC, mAI, mPC, mPI) %>%
    gather(key = "P_type", value = mean_prop, mAC:mPI) %>%
    group_by(P_type) %>%
    get_summary_stats(type = 'mean_se') %>%
    select(P_type, mean, se) %>%
    mutate(data_type = 'Model2')
s1m3 <- fit1to3 %>%
    select(mAC, mAI, mPC, mPI) %>%
    gather(key = "P_type", value = mean_prop, mAC:mPI) %>%
    group_by(P_type) %>%
    get_summary_stats(type = 'mean_se') %>%
    select(P_type, mean, se) %>%
    mutate(data_type = 'Model3')

# dot
# s1 %>%
#   ggplot(aes(x=P_type, y=mean, group=data_type, col=data_type)) + 
#   geom_point(size=1.5) +
#   geom_errorbar(aes(ymin = mean-se, 
#                     ymax = mean+se), 
#                 width=0.1) +
#   ggtitle("Exp1 Subject Data")

s1 <- fit1to1 %>%
  select(AC, AI, PC, PI) %>%
  gather(key = "P_type", value = prop_isa, AC:PI) %>%
  group_by(P_type) %>%
  get_summary_stats(type = 'mean_se') %>%
  select(P_type, mean, se) %>% 
  mutate(data_type = 'Exp1') 

subj1.plot <- s1 %>%
   ggbarplot(x = 'P_type', y = 'mean', fill = 'P_type', palette = 'jco', 
            position = position_dodge(0.8)) + 
  ggtitle("Exp1 Subject Data") + 
  labs(x="", y="mean proportion of producing syntactic structure") +
  ylim(0,1)

ms <- s1m1 %>%
  full_join(s1m2) %>%
  full_join(s1m3)
ms$P_type = rep(c("AC", "AI","PC","PI"), 3)

m.plot = ms %>%
  mutate(syn_voice = factor(ifelse(P_type=="AC"|P_type=="AI", "A", "P")),
         syn_voice = factor(ifelse(P_type=="DOC"|P_type=="DOI", "DO", "PO")),
         syn_corr = factor(ifelse(P_type=="AC"|P_type=="PC", "C", "I")),
         syn_corr = factor(ifelse(P_type=="DOC"|P_type=="POC", "C", "I"))) %>%
  ggbarplot(x = 'data_type', y = 'mean', fill = 'P_type', palette = 'jco', 
            position = position_dodge(0.8)) + 
  ggtitle("Model Simulation Data") + 
  labs(x="", y="mean proportion of producing syntactic structure") +
  ylim(0,1)

s2 <- fit3to1 %>%
  select(DOC, DOI, POC, POI) %>%
  gather(key = "P_type", value = mean_prop, DOC:POI) %>%
  group_by(P_type) %>%
  get_summary_stats(type = 'mean_se') %>%
  select(P_type, mean, se) %>% 
  mutate(data_type = 'Exp2')

subj2.plot = s2 %>%
  ggbarplot(x = 'P_type', y = 'mean', fill = 'P_type', palette = 'jco', 
            position = position_dodge(0.8)) + 
  ggtitle("Exp2 Subject Data") +
  ylim(0,1)

m.plot
subj1.plot
subj2.plot

figure.summary <- ggarrange(ggarrange(subj1.plot, subj2.plot, ncol = 2),
                            m.plot, nrow = 2)

figure.summary
```


### ASP1 and model fitting for individual

model simulation(pred), subject data(mean, sd)
```{r}
# join ASP1 subj data and model1, model2, model3
subj1toall <- fit1to1 %>%
  select(subjID, mAC, mAI, mPC, mPI, min_rmse) %>%
  left_join(fit1to2 %>%
              select(subjID, mAC, mAI, mPC, mPI, min_rmse), 
            by='subjID', suffix=c('.m1', '.m2')) %>%
  left_join(fit1to3 %>%
              select(subjID, mAC, mAI, mPC, mPI, min_rmse) %>%
              setNames(c(names(.)[1], paste0(names(.)[-1],".m3"))), 
            by='subjID') %>%
  # round min_rmse to 3 digits??
  mutate_at(vars(starts_with("min_rmse")), funs(round(., 3)))


# find min min_rmse and categorize which model is the best
subj1toall <- left_join(subj1toall, 
  full_join(
    data.frame(subjID=subj1toall$subjID, min_rmse=pmin(subj1toall$min_rmse.m1, 
                             subj1toall$min_rmse.m2, 
                             subj1toall$min_rmse.m3)), 
    data.frame(subjID=subj1toall$subjID,
               best_model=colnames(subj1toall %>%
           select(starts_with("min_rmse")))[apply(subj1toall %>%
           select(starts_with("min_rmse"))
           ,1,which.min)]), 
    by='subjID'
    ), by='subjID')


library(ggrepel)
library(dplyr)
head(subj1toall)


pie1 <- subj1toall %>% group_by(best_model) %>% 
  summarise(n = n()) %>% mutate(freq = round(n / sum(n), 4), 
                                best_model = gsub("min_rmse.", "", best_model)) %>%
  arrange(desc(best_model)) %>%
  mutate(ypos = cumsum(freq) - 0.5*freq) %>%
  ggplot(aes(x="", y=freq, fill=best_model)) +
  geom_bar(stat="identity", width = 1, color="white") +
  geom_text(aes(y = ypos,label = paste0(freq*100, "%")), color = "white", size=5) +
  coord_polar("y", start = 0) +
  ggtitle('Exp 1 best model fitting') +
  theme_void() 
  
pie1
# Over 75% of subjects in ASP1 find model3 fit better than model1 and model2
```

look at the distribution of rmse 
```{r}
subj1toall %>% select(subjID, min_rmse.m1, min_rmse.m2, min_rmse.m3) %>%
  gather('model', 'min_rmse', min_rmse.m1:min_rmse.m3) %>%
  #group_by(model) %>%
  ggplot(aes(x = model, y = min_rmse, color = model)) + 
  geom_jitter(position = position_jitter(width = 0.4)) + 
  geom_line(stat = "hline", yintercept = "mean")


subj1toall %>%
  ggplot(aes(x = subjID, y = min_rmse, color = best_model)) + 
  geom_jitter(position = position_jitter(width = 0.4))


``` 

# BIC score 
subj data(pred), model simulation data(mean, sd)
Subj1
```{r}
convert_bic <- function(k, n, logL) {
  return(k * log(n) - 2 * logL)
}

convert_z <- function(pred_prop, subj1_mean, P_type) {
  subj_mean = subj1_mean[subj1_mean$P_type==P_type,]$mean
  subj_sd = subj1_mean[subj1_mean$P_type==P_type,]$sd
  return ((pred_prop - subj_mean)/subj_sd)
}

subj1_mean <- fit1to1 %>%
  select(AC, AI, PC, PI) %>%
  gather(key = "P_type", value = prop_isa, AC:PI) %>%
  group_by(P_type) %>%
  get_summary_stats(type = 'mean_sd') %>%
  select(P_type, mean, sd)

model1_mean <- model1 %>%
  select(AC, AI, PC, PI) %>%
  gather(key = "P_type", value = prop_isa, AC:PI) %>%
  group_by(P_type) %>%
  get_summary_stats(type = 'mean_sd') %>%
  select(P_type, mean, sd)


# mean of subj1, model1
subj1model1 <- model1 %>%  
  mutate(AC.z = convert_z(AC, subj1_mean, "AC"),
         AI.z = convert_z(AI, subj1_mean, "AI"),
         PC.z = convert_z(PC, subj1_mean, "PC"),
         PI.z = convert_z(PI, subj1_mean, "PI"))


subj1model1 <- subj1model1 %>%
  bind_cols(subj1model1 %>%
  rowwise() %>%
  summarise(AC.prob_z = dnorm(AC.z,0,1),
            AI.prob_z = dnorm(AI.z,0,1),
            PC.prob_z = dnorm(PC.z,0,1),
            PI.prob_z = dnorm(PI.z,0,1))) %>% 
  mutate(logL = log(AC.prob_z)+
           log(AI.prob_z)+
           log(PC.prob_z)+
           log(PI.prob_z),
         bic = convert_bic(k=3, n=4, logL))

# subj1, model2
subj1model2 <- model2 %>%  
  mutate(AC.z = convert_z(AC, subj1_mean, "AC"),
         AI.z = convert_z(AI, subj1_mean, "AI"),
         PC.z = convert_z(PC, subj1_mean, "PC"),
         PI.z = convert_z(PI, subj1_mean,"PI"))

subj1model2 <- subj1model2 %>%
  bind_cols(subj1model2 %>%
  rowwise() %>%
  summarise(AC.prob_z = dnorm(AC.z,0,1),
            AI.prob_z = dnorm(AI.z,0,1),
            PC.prob_z = dnorm(PC.z,0,1),
            PI.prob_z = dnorm(PI.z,0,1))) %>% 
  mutate(logL = log(AC.prob_z)+log(AI.prob_z)+log(PC.prob_z)+log(PI.prob_z),
         bic = convert_bic(k=5, n=4, logL))


# subj1 mean and sd, model3
subj1model3 <- model3 %>%  
  mutate(AC.z = convert_z(AC, subj1_mean, "AC"),
         AI.z = convert_z(AI, subj1_mean, "AI"),
         PC.z = convert_z(PC, subj1_mean, "PC"),
         PI.z = convert_z(PI, subj1_mean,"PI"))

subj1model3 <- subj1model3 %>%
  bind_cols(subj1model3 %>%
  rowwise() %>%
  summarise(AC.prob_z = dnorm(AC.z,0,1),
            AI.prob_z = dnorm(AI.z,0,1),
            PC.prob_z = dnorm(PC.z,0,1),
            PI.prob_z = dnorm(PI.z,0,1))) %>% 
  mutate(logL = log(AC.prob_z)+log(AI.prob_z)+log(PC.prob_z)+log(PI.prob_z),
         bic = convert_bic(k=4, n=4, logL))

```

Subj2
```{r}
subj2_mean <- fit3to1  %>% 
  anti_join(fit3to1 %>% filter(missing_entries > 4) %>% distinct(surveyID)) %>%
  select(DOC, DOI, POC, POI) %>%
  gather(key = "P_type", value = prop_isa, DOC:POI) %>%
  group_by(P_type) %>%
  get_summary_stats(type = 'mean_sd') %>%
  select(P_type, mean, sd)


# mean of subj1, model1
subj2model1 <- model1 %>%  
  mutate(AC.z = convert_z(AC, subj2_mean, "DOC"),
         AI.z = convert_z(AI, subj2_mean, "DOI"),
         PC.z = convert_z(PC, subj2_mean, "POC"),
         PI.z = convert_z(PI, subj2_mean, "POI"))

subj2model1 <- subj2model1 %>%
  bind_cols(subj2model1 %>%
  rowwise() %>%
  summarise(AC.prob_z = dnorm(AC.z,0,1),
            AI.prob_z = dnorm(AI.z,0,1),
            PC.prob_z = dnorm(PC.z,0,1),
            PI.prob_z = dnorm(PI.z,0,1))) %>% 
  mutate(logL = log(AC.prob_z)+log(AI.prob_z)+log(PC.prob_z)+log(PI.prob_z),
         bic = convert_bic(k=3, n=4, logL))

# mean of subj1, model1
subj2model2 <- model2 %>%  
  mutate(AC.z = convert_z(AC, subj2_mean, "DOC"),
         AI.z = convert_z(AI, subj2_mean, "DOI"),
         PC.z = convert_z(PC, subj2_mean, "POC"),
         PI.z = convert_z(PI, subj2_mean, "POI"))

subj2model2 <- subj2model2 %>%
  bind_cols(subj2model2 %>%
  rowwise() %>%
  summarise(AC.prob_z = dnorm(AC.z,0,1),
            AI.prob_z = dnorm(AI.z,0,1),
            PC.prob_z = dnorm(PC.z,0,1),
            PI.prob_z = dnorm(PI.z,0,1))) %>% 
  mutate(logL = log(AC.prob_z)+log(AI.prob_z)+log(PC.prob_z)+log(PI.prob_z),
         bic = convert_bic(k=5, n=4, logL))

# mean of subj2, model3
subj2model3 <- model3 %>%  
  mutate(AC.z = convert_z(AC, subj2_mean, "DOC"),
         AI.z = convert_z(AI, subj2_mean, "DOI"),
         PC.z = convert_z(PC, subj2_mean, "POC"),
         PI.z = convert_z(PI, subj2_mean, "POI"))

subj2model3 <- subj2model3 %>%
  bind_cols(subj2model3 %>%
  rowwise() %>%
  summarise(AC.prob_z = dnorm(AC.z,0,1),
            AI.prob_z = dnorm(AI.z,0,1),
            PC.prob_z = dnorm(PC.z,0,1),
            PI.prob_z = dnorm(PI.z,0,1))) %>% 
  mutate(logL = log(AC.prob_z)+log(AI.prob_z)+log(PC.prob_z)+log(PI.prob_z),
         bic = convert_bic(k=4, n=4, logL))

```

```{r}
subj1model1 %>% select(bic) %>% get_summary_stats(type = "min")
subj1model2 %>% select(bic) %>% get_summary_stats(type = "min")
subj1model3 %>% select(bic) %>% get_summary_stats(type = "min")


bic.plot <- ggarrange(
  gghistogram(subj1model1, x = "bic", add = "median", add_density = TRUE)+ 
    ggtitle("Model1 fit Exp1", 
            subtitle = paste0("min bic = ", round(min(subj1model1$bic),3))),
  gghistogram(subj1model2, x = "bic", add = "median", add_density = TRUE)+ 
    ggtitle("Model2 fit Exp1", 
            subtitle = paste0("min bic = ", round(min(subj1model2$bic),3))), 
  gghistogram(subj1model3, x = "bic", add = "median", add_density = TRUE)+ 
    ggtitle("Model3 fit Exp1",
            subtitle = paste0("min bic = ", round(min(subj1model3$bic),3))),
  gghistogram(subj2model1, x = "bic", add = "median", add_density = TRUE)+ 
    ggtitle("Model1 fit Exp2",
            subtitle = paste0("min bic = ", round(min(subj2model1$bic),3))),
  gghistogram(subj2model2, x = "bic", add = "median", add_density = TRUE)+ 
    ggtitle("Model2 fit Exp2",
            subtitle = paste0("min bic = ", round(min(subj2model2$bic),3))),
  gghistogram(subj2model3, x = "bic", add = "median", add_density = TRUE)+ 
    ggtitle("Model3 fit Exp2",
            subtitle = paste0("min bic = ", round(min(subj2model3$bic),3))),
  nrow = 2, ncol = 3
)

bic.plot <- ggarrange(
  gghistogram(subj1model1, x = "bic", add = "median", add_density = TRUE, color="#F8766D")+ 
    ggtitle("Model1 fitting Exp Data", 
            subtitle = paste0("min bic = ", round(min(subj1model1$bic),3))),
  gghistogram(subj1model2, x = "bic", add = "median", add_density = TRUE, color="#00B81F")+ 
    ggtitle("Model2 fitting Exp Data", 
            subtitle = paste0("min bic = ", round(min(subj1model2$bic),3))), 
  gghistogram(subj1model3, x = "bic", add = "median", add_density = TRUE,  color="#00A5FF")+ 
    ggtitle("Model3 fitting Exp Data",
            subtitle = paste0("min bic = ", round(min(subj1model3$bic),3))),
  nrow = 1, ncol = 3
)

bic.plot

bic.plot = subj1model1 %>% select(X1, bic) %>%
  full_join(subj1model2 %>% select(X1, bic), by="X1", suffix=c(".m1", ".m2"))  %>%
  full_join(subj1model3 %>% select(X1, bic), by="X1") %>% rename(bic.m3 = bic) %>%
  gather(key = "model", value="min_bic", bic.m1:bic.m3) %>% 
  group_by(model) %>%
  gghistogram(x = "min_bic", add = "median", add_density = TRUE, bins = 50, col = "model", 
              alpha = .5, merge = TRUE) +
   ggtitle("BIC score of model fitting",
            subtitle = paste0("min BIC: ", round(min(subj1model3$bic),3)))

bic.plot

```

### ASP3 and model fitting for individuals

simulation model data(pred), subj(mean, sd)
```{r}
# join ASP3 subj data and model1, model2, model3
subj3toall <- fit3to1 %>%
  select(surveyID, mDOC, mDOI, mPOC, mPOI, min_rmse) %>%
  left_join(fit3to2 %>%
              select(surveyID, mDOC, mDOI, mPOC, mPOI, min_rmse), 
            by='surveyID', suffix=c('.m1', '.m2')) %>%
  left_join(fit3to3 %>%
              select(surveyID, mDOC, mDOI, mPOC, mPOI, min_rmse) %>%
              setNames(c(names(.)[1], paste0(names(.)[-1],".m3"))), 
            by='surveyID') %>%
  mutate_at(vars(starts_with("min_rmse")), funs(round(., 3)))

# find min min_rmse and subj3toall which model is the best
subj3toall <- left_join(subj3toall, 
  full_join(
    data.frame(surveyID=subj3toall$surveyID, min_rmse=pmin(subj3toall$min_rmse.m1, 
                             subj3toall$min_rmse.m2, 
                             subj3toall$min_rmse.m3)), 
    data.frame(surveyID=subj3toall$surveyID,
               best_model=colnames(subj3toall %>%
           select(starts_with("min_rmse")))[apply(subj3toall %>%
           select(starts_with("min_rmse"))
           ,1,which.min)]), 
    by='surveyID'
    ), by='surveyID')

subj3toall %>% head()

# using exclusion criteria as ASP3 analysis

subj3toall.clean <- subj3toall %>% anti_join(fit3to1 %>% filter(missing_entries > 4) %>% distinct(surveyID))

# only old data
#subj3toall.old <- subj3toall %>%anti_join(fit3to1 %>% filter(old==TRUE) %>% distinct(surveyID))

# p3.1 = subj3toall %>% group_by(best_model) %>% 
#   summarise(n = n()) %>% mutate(freq = n / sum(n)) %>%
#   ggplot(aes(x="", y=n, fill=best_model)) +
#   geom_bar(stat="identity", width=1) +
#   coord_polar("y", start=0) +
#   theme_void() +
#   ggtitle('ASP3 min_RMSE (All)')
# 
# p3.2 = subj3toall.old %>% group_by(best_model) %>% 
#   summarise(n = n()) %>% mutate(freq = n / sum(n)) %>%
#   ggplot(aes(x="", y=n, fill=best_model)) +
#   geom_bar(stat="identity", width=1) +
#   coord_polar("y", start=0) +
#   theme_void() +
#   ggtitle('ASP3 min_RMSE (Old)')

p3 = subj3toall.clean %>% group_by(best_model) %>% 
  summarise(n = n()) %>% mutate(freq = n / sum(n)) %>%
  ggplot(aes(x="", y=n, fill=best_model)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  theme_void() +
  ggtitle('ASP3 min_RMSE (Clen)')


library(forcats)
pie3 = subj3toall.clean %>% group_by(best_model) %>% 
  summarise(n = n()) %>% mutate(freq = (round(n / sum(n), 4)), 
                                best_model = factor(gsub("min_rmse.", "", best_model))) %>% 
  arrange(desc(best_model)) %>%
  mutate(ypos = cumsum(freq) - 0.5*freq) %>%
  ggplot(aes(x="", y=freq, fill=best_model)) +
  geom_bar(stat="identity", width = 1, color="white") +
  geom_text(aes(y = ypos,label = paste0(freq*100, "%")), color = "white", size=5) +
  coord_polar("y", start = 0) +
  ggtitle('Exp 2 best model fitting') +
  theme_void() 
pie3

figure.pie <- ggarrange(pie1, pie3,
                    labels = c("A", "B"),
                    ncol = 2, nrow = 1)
figure.pie
```

### BIC 

new bic calculation: 
- subj (mean, sd)
- model(pred)
asp1
```{r}
BIC = function(n, rmse, k) {
  rss = rmse^2 * n
  return(n + n * log(2 * pi) + n * log(rss/n) + log(n) * (k + 1) )
}


fit1to1 <- fit1to1 %>% rowwise() %>% 
  mutate(min_bic= BIC(4, min_rmse, 3))
fit1to2 <- fit1to2 %>% rowwise() %>% 
  mutate(min_bic= BIC(4, min_rmse, 4))
fit1to3 <- fit1to3 %>% rowwise() %>% 
  mutate(min_bic= BIC(4, min_rmse, 4))

# join ASP1 subj data and model1, model2, model3
subj1toall.bic <-fit1to1 %>%
  select(subjID, mAC, mAI, mPC, mPI, min_rmse) %>%
  left_join(fit1to2 %>%
              select(subjID, mAC, mAI, mPC, mPI, min_rmse), 
            by='subjID', suffix=c('.m1', '.m2')) %>%
  left_join(fit1to3 %>%
              select(subjID, mAC, mAI, mPC, mPI, min_rmse) %>%
              setNames(c(names(.)[1], paste0(names(.)[-1],".m3"))), 
            by='subjID') %>%
  # round min_rmse to 3 digits??
  mutate_at(vars(starts_with("min_bic")), funs(round(., 3)))

# find min min_rmse and categorize which model is the best
subj1toall.bic <- left_join(subj1toall.bic, 
  full_join(
    data.frame(subjID=subj1toall.bic$subjID, min_rmse=pmin(subj1toall.bic$min_rmse.m1, 
                             subj1toall.bic$min_rmse.m2, 
                             subj1toall.bic$min_rmse.m3)), 
    data.frame(subjID=subj1toall.bic$subjID,
               best_model=colnames(subj1toall.bic %>%
           select(starts_with("min_rmse")))[apply(subj1toall.bic %>%
           select(starts_with("min_rmse"))
           ,1,which.min)]), 
    by='subjID'
    ), by='subjID')

p1 = subj1toall.bic %>% group_by(best_model) %>% 
  summarise(n = n()) %>% mutate(freq = n / sum(n)) %>%
  ggplot(aes(x="", y=n, fill=best_model)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  theme_void() +
  ggtitle('ASP1 Min_BIC')

p1
```

asp3
```{r}


fit3to1 <- fit3to1 %>% rowwise() %>% 
  mutate(min_bic= BIC(4, min_rmse, 3))
fit3to2 <- fit3to2 %>% rowwise() %>% 
  mutate(min_bic= BIC(4, min_rmse, 4))
fit3to3 <- fit3to3 %>% rowwise() %>% 
  mutate(min_bic= BIC(4, min_rmse, 4))

# join ASP3 subj data and model1, model2, model3
subj3toall.bic <- fit3to1 %>%
  select(surveyID, mDOC, mDOI, mPOC, mPOI, min_bic) %>%
  left_join(fit3to2 %>%
              select(surveyID, mDOC, mDOI, mPOC, mPOI, min_bic), 
            by='surveyID', suffix=c('.m1', '.m2')) %>%
  left_join(fit3to3 %>%
              select(surveyID, mDOC, mDOI, mPOC, mPOI, min_bic) %>%
              setNames(c(names(.)[1], paste0(names(.)[-1],".m3"))), 
            by='surveyID') %>%
  mutate_at(vars(starts_with("min_bic")), funs(round(., 3)))

# find min min_rmse and subj3toall which model is the best
subj3toall.bic <- left_join(subj3toall.bic, 
  full_join(
    data.frame(surveyID=subj3toall.bic$surveyID, min_rmse=pmin(subj3toall.bic$min_bic.m1, 
                             subj3toall.bic$min_bic.m2, 
                             subj3toall.bic$min_bic.m3)), 
    data.frame(surveyID=subj3toall.bic$surveyID,
               best_model=colnames(subj3toall.bic %>%
           select(starts_with("min_bic")))[apply(subj3toall.bic %>%
           select(starts_with("min_bic"))
           ,1,which.min)]), 
    by='surveyID'
    ), by='surveyID')

subj3toall.bic %>% head()
subj3toall.bic.clean <- subj3toall.bic %>% anti_join(fit3to1 %>% filter(missing_entries > 4) %>% distinct(surveyID))
subj3toall.bic.old <- subj3toall.bic %>%anti_join(fit3to1 %>% filter(old==TRUE) %>% distinct(surveyID))

p3.4 = subj3toall.bic %>% group_by(best_model) %>% 
  summarise(n = n()) %>% mutate(freq = n / sum(n)) %>%
  ggplot(aes(x="", y=n, fill=best_model)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  theme_void() +
  ggtitle('ASP3 Min_BIC (All)')

p3.5 = subj3toall.bic.old %>% group_by(best_model) %>% 
  summarise(n = n()) %>% mutate(freq = n / sum(n)) %>%
  ggplot(aes(x="", y=n, fill=best_model)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  theme_void() +
  ggtitle('ASP3 Min_BIC (Old)')

p3.6 = subj3toall.bic.clean %>% group_by(best_model) %>% 
  summarise(n = n()) %>% mutate(freq = n / sum(n)) %>%
  ggplot(aes(x="", y=n, fill=best_model)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  theme_void() +
  ggtitle('ASP3 Min_BIC (Clean)')

figure <- ggarrange(p1, p3.1, p3.2, p3.3, p3.4, p3.5, p3.6,
                    labels = c("A", "B", "C", "D", "E", "F"),
                    ncol = 2, nrow = 4)
figure
```


```{r}
subj1_rmse = subj1toall %>% select(min_rmse.m1, min_rmse.m2, min_rmse.m3, best_model)
subj3_rmse = subj3toall %>% select(min_rmse.m1, min_rmse.m2, min_rmse.m3, best_model)

# model fit 1
subj1_rmse %>% select(-best_model) %>%
  gather(key = 'model', value = 'rmse', min_rmse.m1:min_rmse.m3) %>% 
  pairwise_t_test(
    rmse ~ model, pool.sd = FALSE, paired = TRUE,
    p.adjust.method = "bonferroni"
    )

# model fit 2
subj3_rmse %>% select(-best_model) %>%
  gather(key = 'model', value = 'rmse', min_rmse.m1:min_rmse.m3) %>% 
  pairwise_t_test(
    rmse ~ model, pool.sd = FALSE, paired = TRUE,
    p.adjust.method = "bonferroni"
    )

```


### BIC model fit individual
bic: model fit individuals in exp1 
```{r}

convert_bic <- function(k, n, logL) {
  return(k * log(n) - 2 * logL)
}

subj1 <- read_csv("./MODEL1/ASP1MODEL1_reg.csv") %>% select(X1:missing_entries)
subj2 <- read_csv("./MODEL1/ASP3MODEL1_reg.csv") %>% select(X1:missing_entries) %>%
  rename(subjID=surveyID, AC=DOC, AI=DOI, PC=POC, PI=POI)

model1 = read_csv('./MODEL1/MODEL1_wide.csv') %>% 
  rename(AC.m=DOC,AI.m=DOI,PC.m=POC, PI.m=POI, AC.sd=DOC_sd,AI.sd=DOI_sd,PC.sd=POC_sd, PI.sd=POI_sd)
model2 = read_csv('./MODEL2/MODEL2_wide.csv') %>% 
  rename(AC.m=DOC,AI.m=DOI,PC.m=POC, PI.m=POI, AC.sd=DOC_sd,AI.sd=DOI_sd,PC.sd=POC_sd, PI.sd=POI_sd)
model3 = read_csv('./MODEL3/MODEL3_wide.csv') %>% 
  rename(AC.m=DOC,AI.m=DOI,PC.m=POC, PI.m=POI, AC.sd=DOC_sd,AI.sd=DOI_sd,PC.sd=POC_sd, PI.sd=POI_sd)

# fit one row of model simulation to subj data
subj2sim <- function(subj, model.r, k) {
  sim0 = subj %>%
    merge.data.frame(model.r) %>%
    mutate(AC.z=(AC-AC.m)/max(AC.sd, 1e-10),
           AI.z=(AI-AI.m)/max(AI.sd, 1e-10),
           PC.z=(PC-PC.m)/max(PC.sd, 1e-10),
           PI.z=(PI-PI.m)/max(PI.sd, 1e-10),
           AC.prob_z=dnorm(AC.z, 0, 1), 
           AI.prob_z=dnorm(AI.z, 0, 1),
           PC.prob_z=dnorm(PC.z, 0, 1),
           PI.prob_z=dnorm(PI.z, 0, 1),
           logL=log(AC.prob_z)+log(AI.prob_z)+log(PC.prob_z)+log(PI.prob_z),
           bic=convert_bic(k, n=4, logL))
  return(sim0)
}

# concate all df togeter
subj2model <- function(subj, model, k) {
  datalist = list()
  for (i in 1:nrow(model)) {
    model.r=model[i,]
    dat = subj2sim(subj, model.r, k)
    datalist[[i]] <- dat
  }
  result = data.frame(do.call(rbind, datalist))
  return(result)
}


subj1model1 = subj2model(subj1, model1, 3) #70*150=10,500
subj1model2 = subj2model(subj1, model2, 5) #70*1440=100,800
subj1model3 = subj2model(subj=subj1, model=model3, k=4) #70*900=63,000
  

subj1models = subj1model1 %>% group_by(subjID) %>% 
  get_summary_stats(bic, show = c('min', 'median', 'q1')) %>%
  select(-variable, -n) %>%
  arrange(subjID) %>%
  full_join(subj1model2 %>% group_by(subjID) %>% 
              get_summary_stats(bic, show = c('min', 'median', 'q1')) %>%
              select(-variable, -n) %>%
              arrange(subjID), 
  by = 'subjID', suffix=c('.m1', '.m2')) %>%
  full_join(subj1model3 %>% group_by(subjID) %>% 
              get_summary_stats(bic, show = c('min', 'median', 'q1')) %>%
              select(-variable, -n) %>%
              setNames(c(names(.)[1], paste0(names(.)[-1],".m3"))) %>% 
              arrange(subjID), 
  by = 'subjID')


subj1models %>% select(subjID, min.m1, min.m2, min.m3)

# find min min_rmse and categorize which model is the best
subj1tomodels <- left_join(subj1models, 
  full_join(
    data.frame(subjID=subj1models$subjID, min_bic=pmin(subj1models$min.m1, 
                             subj1models$min.m2, 
                             subj1models$min.m3)), 
    data.frame(subjID=subj1toall$subjID,
               best_model=colnames(subj1models %>%
           select(starts_with("min")))[apply(subj1toall %>%
           select(starts_with("min"))
           ,1,which.min)]), 
    by='subjID'
    ), by='subjID')

subj1_bestmodels = subj1models %>%
  rowwise() %>%
  mutate(min_bic = pmin(min.m1, min.m2, min.m3)) %>%
  #mutate(min_bic = pmin(q1.m1, q1.m2, q1.m3)) %>%
  bind_cols(best_model = colnames(subj1models %>% 
                                 select(starts_with("min")))[apply(subj1models %>% 
                                                                     select(starts_with("min")),1,which.min)])
         



#gghistogram(subj1model1 %>% filter(subjID==3), x = "bic", add = "median", add_density = TRUE, bins = 50)
subj1_bestmodels %>% select(subjID, min_bic, best_model) %>% 
  ggplot(aes(x=subjID, y=min_bic, fill=best_model)) +
  geom_col()

# subj_bestmodels_long = subj_bestmodels %>% 
#   select(subjID, min.m1, median.m1, q1.m1) %>%
#   mutate(model='model1') %>%
#   rename(min=min.m1, median=median.m1, q1=q1.m1) %>%
#   bind_rows(subj_bestmodels %>% 
#   select(subjID, min.m2, median.m2, q1.m2) %>%
#   mutate(model='model2') %>%
#   rename(min=min.m2, median=median.m2, q1=q1.m2)) %>%
#   bind_rows(subj_bestmodels %>% 
#   select(subjID, min.m3, median.m3, q1.m3) %>%
#   mutate(model='model3') %>%
#   rename(min=min.m3, median=median.m3, q1=q1.m3))


# subj_bestmodels_long %>%
#   filter(subjID < 30) %>%
#   ggplot(aes(x=subjID), position = position_jitterdodge(jitter.width = 0.5, dodge.width=0.2)) +
#   geom_linerange(mapping = aes(x=subjID, ymin=min, ymax=median, width=.1, col=model), linetype=2) +
#   geom_point(aes(x=subjID, y=q1, col=model, shape=model, size=4)) 


pie1 = subj1_bestmodels %>%
  group_by(best_model) %>% 
  summarise(n = n()) %>% mutate(freq = (round(n / sum(n), 4)), 
                                best_model = factor(gsub("min.", "", best_model))) %>% 
  arrange(desc(best_model)) %>%
  mutate(ypos = cumsum(freq) - 0.5*freq) %>%
  ggplot(aes(x="", y=freq, fill=best_model)) +
  geom_bar(stat="identity", width = 1, color="white") +
  geom_text(aes(y = ypos,label = paste0(freq*100, "%")), color = "white", size=5) +
  coord_polar("y", start = 0) +
  ggtitle('Exp 1 indiviudal fitting') +
  theme_void() 

pie1

```


fit individuals of exp2
```{r}

subj2model1 = subj2model(subj2, model1, 3) #141*150=21,150
subj2model2 = subj2model(subj2, model2, 5) #141*1440=203,040
subj2model3 = subj2model(subj=subj2, model=model3, k=4) #141*900=126,900
  

subj2models = subj2model1 %>% group_by(subjID) %>% 
  get_summary_stats(bic, show = c('min', 'median', 'q1')) %>%
  select(-variable, -n) %>%
  arrange(subjID) %>%
  full_join(subj2model2 %>% group_by(subjID) %>% 
              get_summary_stats(bic, show = c('min', 'median', 'q1')) %>%
              select(-variable, -n) %>%
              arrange(subjID), 
  by = 'subjID', suffix=c('.m1', '.m2')) %>%
  full_join(subj2model3 %>% group_by(subjID) %>% 
              get_summary_stats(bic, show = c('min', 'median', 'q1')) %>%
              select(-variable, -n) %>%
              setNames(c(names(.)[1], paste0(names(.)[-1],".m3"))) %>% 
              arrange(subjID), 
  by = 'subjID')

subj2_bestmodels = subj2models %>%
  rowwise() %>%
  mutate(min_bic = pmin(min.m1, min.m2, min.m3)) %>%
  #mutate(min_bic = pmin(q1.m1, q1.m2, q1.m3)) %>%
  bind_cols(best_model = colnames(subj2models %>% 
                                 select(starts_with("min")))[apply(subj2models %>% 
                                                                     select(starts_with("min")),1,which.min)])
# pie chart
pie2 = subj2_bestmodels %>%
  group_by(best_model) %>% 
  summarise(n = n()) %>% mutate(freq = (round(n / sum(n), 4)), 
                                best_model = factor(gsub("min.", "", best_model))) %>% 
  arrange(desc(best_model)) %>%
  mutate(ypos = cumsum(freq) - 0.5*freq) %>%
  ggplot(aes(x="", y=freq, fill=best_model)) +
  geom_bar(stat="identity", width = 1, color="white") +
  geom_text(aes(y = ypos,label = paste0(freq*100, "%")), color = "white", size=5) +
  coord_polar("y", start = 0) +
  ggtitle('Exp 2 individual fitting') +
  theme_void() 

# 
subj2_bestmodels %>% select(subjID, min_bic, best_model) %>% 
  ggplot(aes(x=subjID, y=min_bic, fill=best_model)) +
  geom_col()

pie2

figure.pie <- ggarrange(pie1, pie2,
                    labels = c("A", "B"),
                    ncol = 2, nrow = 1)
figure.pie
```